pipeline {
    agent any

    environment {
        // ======== Docker Hub ========
        DOCKER_HUB     = "truongcongly"
        FRONTEND_IMAGE = "${DOCKER_HUB}/frontend:latest"
        BACKEND_IMAGE  = "${DOCKER_HUB}/backend:latest"

        // ======== EC2 (ch·ªâ b·∫≠t khi deploy th·∫≠t) ========
        EC2_USER = "ubuntu"
        EC2_HOST = "52.221.176.126"
        DEPLOY_SCRIPT = "~/deploy_to_ec2.sh"
    }

    stages {

        stage('Docker Login') {
            steps {
                echo "üîê Logging into Docker Hub..."
                withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-cred',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        echo "üß© Logging in as $DOCKER_USER"
                        docker login -u $DOCKER_USER -p $DOCKER_PASS
                    '''
                }
            }
        }

        stage('Build & Push Images (Parallel)') {
            // parallel {
            //     stage('Frontend Build & Push') {
            //         steps {
            //             script {
            //                 echo "üöÄ Building & pushing Frontend image..."
            //                 sh """
            //                     docker build -t ${FRONTEND_IMAGE} ./frontend
            //                     docker push ${FRONTEND_IMAGE}
            //                 """
            //             }
            //         }
            //     }

            //     stage('Backend Build & Push') {
            //         steps {
            //             script {
            //                 echo "‚öôÔ∏è Building & pushing Backend image..."
            //                 sh """
            //                     docker build -t ${BACKEND_IMAGE} ./backend
            //                     docker push ${BACKEND_IMAGE}
            //                 """
            //             }
            //         }
            //     }
            // }

            steps {
                script {
                    // Build frontend
                    sh "docker build -t ${FRONTEND_IMAGE} ./frontend"
                    // Build backend
                    sh "docker build -t ${BACKEND_IMAGE} ./backend"
                    // Push frontend + backend
                    sh "docker push ${FRONTEND_IMAGE}"
                    sh "docker push ${BACKEND_IMAGE}"
                }
            }
        }

        stage('Deploy to EC2') {
            when {
                expression { return true } 
            }
            steps {
                echo "üöÄ Deploying to EC2 server..."
                sshagent(['ec2-deploy-key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} \
                        'bash -s' < ${DEPLOY_SCRIPT}
                    '''
                }
            }
        }

    }

    post {
        success {
            echo "üéâ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
